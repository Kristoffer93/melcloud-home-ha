<!DOCTYPE html>
<html>
<head>
    <title>MELCloud Home Cookie Helper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .step {
            background: #f5f5f5;
            border-left: 4px solid #03a9f4;
            padding: 15px;
            margin: 15px 0;
        }
        .step h3 {
            margin-top: 0;
            color: #03a9f4;
        }
        code {
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        button {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #0288d1;
        }
        #result {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            display: none;
            word-break: break-all;
        }
        .copy-btn {
            background: #4caf50;
        }
        .copy-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>üç™ MELCloud Home Cookie Extractor</h1>
    
    <div class="warning">
        ‚ö†Ô∏è <strong>Viktigt:</strong> Denna sida fungerar endast om du √§r inloggad p√• <code>melcloudhome.com</code> i samma webbl√§sare.
    </div>

    <div class="step">
        <h3>Steg 1: Logga in p√• MELCloud Home</h3>
        <p>√ñppna <a href="https://melcloudhome.com" target="_blank">melcloudhome.com</a> i en ny flik och logga in med ditt konto.</p>
        <button onclick="window.open('https://melcloudhome.com', '_blank')">√ñppna MELCloud Home</button>
    </div>

    <div class="step">
        <h3>Steg 2: Extrahera Cookie</h3>
        <p>N√§r du √§r inloggad, klicka p√• knappen nedan f√∂r att f√∂rs√∂ka extrahera cookien automatiskt:</p>
        <button onclick="extractCookie()">Extrahera Cookie</button>
    </div>

    <div id="result">
        <h3>‚úÖ Cookie extraherad!</h3>
        <p><strong>Cookie-v√§rde:</strong></p>
        <textarea id="cookieValue" readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 12px;"></textarea>
        <br>
        <button class="copy-btn" onclick="copyCookie()">üìã Kopiera Cookie</button>
        <p style="margin-top: 15px; font-size: 14px; color: #666;">
            Klistra in denna cookie-str√§ng n√§r du konfigurerar MELCloud Home-integrationen i Home Assistant.
        </p>
    </div>

    <div class="step">
        <h3>Steg 3: Manuell extraktion (om automatisk misslyckas)</h3>
        <p>Om automatisk extraktion inte fungerar, f√∂lj dessa steg:</p>
        <ol>
            <li>√ñppna Developer Tools (tryck <code>F12</code>)</li>
            <li>G√• till <strong>Network</strong> tab</li>
            <li>Ladda om sidan p√• melcloudhome.com (<code>F5</code>)</li>
            <li>Klicka p√• f√∂rsta requesten i listan</li>
            <li>Scrolla ner till <strong>Request Headers</strong></li>
            <li>Hitta <code>cookie:</code> raden</li>
            <li>H√∂gerklicka p√• v√§rdet ‚Üí <strong>Copy value</strong></li>
        </ol>
    </div>

    <script>
        async function extractCookie() {
            // F√∂rs√∂k 1: L√§s fr√•n document.cookie (fungerar inte f√∂r HttpOnly)
            let cookie = document.cookie;
            
            if (!cookie || cookie.trim() === '') {
                // F√∂rs√∂k 2: Fetch med credentials f√∂r att trigga cookie-header
                try {
                    const response = await fetch('https://melcloudhome.com/api/user/context', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'x-csrf': '1'
                        }
                    });
                    
                    // F√∂rs√∂k extrahera fr√•n response headers (fungerar inte pga CORS)
                    const cookieHeader = response.headers.get('set-cookie');
                    if (cookieHeader) {
                        cookie = cookieHeader;
                    }
                } catch (e) {
                    console.error('Fetch failed:', e);
                }
            }
            
            if (!cookie || cookie.trim() === '') {
                alert('‚ö†Ô∏è Automatisk cookie-extraktion misslyckades!\n\n' +
                      'HttpOnly-cookies kan inte l√§sas via JavaScript av s√§kerhetssk√§l.\n\n' +
                      'F√∂lj ist√§llet de manuella stegen nedan med Developer Tools (F12).');
                return;
            }
            
            // Visa resultat
            document.getElementById('cookieValue').value = cookie;
            document.getElementById('result').style.display = 'block';
        }
        
        function copyCookie() {
            const textarea = document.getElementById('cookieValue');
            textarea.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Kopierad!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }
        
        // Kolla om anv√§ndaren redan √§r p√• melcloudhome.com
        if (window.location.hostname === 'melcloudhome.com') {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px;">' +
                '<h2>‚ö†Ô∏è Fel sida</h2>' +
                '<p>Denna helper-sida ska inte k√∂ras direkt p√• melcloudhome.com.</p>' +
                '<p>√ñppna ist√§llet denna HTML-fil lokalt i din webbl√§sare.</p>' +
                '</div>';
        }
    </script>
</body>
</html>
